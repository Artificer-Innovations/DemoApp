name: PR Preview Environments

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
      - closed

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    env:
      PREVIEW_DOMAIN: ${{ vars.PR_PREVIEW_DOMAIN }}
      PREVIEW_HOSTED_ZONE_ID: ${{ vars.PR_PREVIEW_HOSTED_ZONE_ID }}
      PREVIEW_CERTIFICATE_ARN: ${{ secrets.PR_PREVIEW_CERTIFICATE_ARN }}
      PREVIEW_STACK_NAME: ${{ vars.PR_PREVIEW_STACK_NAME }}
      PREVIEW_PREFIX: ${{ vars.PR_PREVIEW_PREFIX }}
      SUPABASE_PREVIEW_PROJECT_REF: ${{ secrets.SUPABASE_PREVIEW_PROJECT_REF }}
      SUPABASE_PREVIEW_DB_PASSWORD: ${{ secrets.SUPABASE_PREVIEW_DB_PASSWORD }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PREVIEW_DB_URL: ${{ secrets.SUPABASE_PREVIEW_DB_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 2.54.11

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ vars.PR_PREVIEW_AWS_REGION != '' && vars.PR_PREVIEW_AWS_REGION || 'us-east-1' }}

      - name: Bootstrap preview infrastructure
        id: bootstrap
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="${PREVIEW_STACK_NAME:-beakerstack-pr-preview}"
          AWS_REGION_VALUE="${PREVIEW_AWS_REGION:-us-east-1}"
          PREVIEW_PREFIX_VALUE="${PREVIEW_PREFIX:-pr-}"
          ./scripts/pr-preview/bootstrap-aws-stack.sh \
            --stack-name "${STACK_NAME}" \
            --region "${AWS_REGION_VALUE}" \
            --domain "${PREVIEW_DOMAIN}" \
            --hosted-zone-id "${PREVIEW_HOSTED_ZONE_ID}" \
            --certificate-arn "${PREVIEW_CERTIFICATE_ARN}" \
            --preview-prefix "${PREVIEW_PREFIX_VALUE}"

      - name: Prepare Supabase preview database
        id: supabase
        shell: bash
        continue-on-error: true
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SUPABASE_MAX_RETRIES: 5
        run: |
          set -euo pipefail
          ./scripts/pr-preview/reset-preview-database.sh \
            --pr-number "${PR_NUMBER}" \
            --project-ref "${SUPABASE_PREVIEW_PROJECT_REF}" \
            --db-password "${SUPABASE_PREVIEW_DB_PASSWORD}" \
            --baseline-ref "${{ github.base_ref }}" \
            --skip-if-unchanged

      - name: Build and deploy web preview
        id: web
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VITE_SUPABASE_URL: ${{ secrets.PREVIEW_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.PREVIEW_SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          PR_NUMBER_VALUE="${PR_NUMBER}"
          PREVIEW_PREFIX_VALUE="${PREVIEW_PREFIX:-${{ steps.bootstrap.outputs.PR_PREVIEW_PREFIX }}}"
          PREVIEW_PREFIX_VALUE="${PREVIEW_PREFIX_VALUE:-pr-}"
          AWS_REGION_VALUE="${PREVIEW_AWS_REGION:-us-east-1}"
          ./scripts/pr-preview/deploy-web.sh \
            --pr-number "${PR_NUMBER_VALUE}" \
            --bucket "${{ steps.bootstrap.outputs.PR_PREVIEW_WEBSITE_BUCKET }}" \
            --distribution-id "${{ steps.bootstrap.outputs.PR_PREVIEW_DISTRIBUTION_ID }}" \
            --domain "${PREVIEW_DOMAIN}" \
            --environment preview \
            --preview-prefix "${PREVIEW_PREFIX_VALUE}" \
            --region "${AWS_REGION_VALUE}"

      - name: Deploy mobile preview
        id: mobile
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_PROJECT_ID: ${{ secrets.EXPO_PROJECT_ID }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.PREVIEW_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PREVIEW_SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          PR_NUMBER_VALUE="${PR_NUMBER}"
          EXPO_ACCOUNT_VALUE="${{ vars.EXPO_ACCOUNT }}"
          if [[ -z "${EXPO_ACCOUNT_VALUE}" ]]; then
            echo "Warning: EXPO_ACCOUNT not set, skipping mobile deployment"
            exit 0
          fi
          ./scripts/pr-preview/deploy-mobile.sh \
            --pr-number "${PR_NUMBER_VALUE}" \
            --expo-account "${EXPO_ACCOUNT_VALUE}" \
            --platform all

      - name: Post preview summary comment
        if: always()
        uses: actions/github-script@v7
        env:
          WEB_URL: ${{ steps.web.outputs.PREVIEW_WEB_URL }}
          MOBILE_CHANNEL: ${{ steps.mobile.outputs.PREVIEW_MOBILE_CHANNEL }}
          MOBILE_UPDATE_URL: ${{ steps.mobile.outputs.PREVIEW_MOBILE_UPDATE_URL }}
        with:
          script: |
            const marker = '<!-- pr-preview-links -->';
            const webUrl = process.env.WEB_URL;
            const mobileChannel = process.env.MOBILE_CHANNEL;
            const mobileUpdateUrl = process.env.MOBILE_UPDATE_URL;

            const lines = [];
            lines.push('<!-- pr-preview-links -->');
            if (webUrl) {
              lines.push(`ðŸŒ **Web preview:** ${webUrl}`);
            }
            if (mobileUpdateUrl) {
              lines.push(`ðŸ“± **Mobile preview:** Channel \`${mobileChannel}\` - [View updates](${mobileUpdateUrl})`);
            }
            const body = lines.join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  teardown-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    env:
      PREVIEW_STACK_NAME: ${{ vars.PR_PREVIEW_STACK_NAME }}
      PREVIEW_PREFIX: ${{ vars.PR_PREVIEW_PREFIX }}
      SUPABASE_PREVIEW_DB_URL: ${{ secrets.SUPABASE_PREVIEW_DB_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ vars.PR_PREVIEW_AWS_REGION != '' && vars.PR_PREVIEW_AWS_REGION || 'us-east-1' }}

      - name: Resolve infrastructure outputs
        id: describe
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="${PREVIEW_STACK_NAME:-beakerstack-pr-preview}"
          AWS_REGION_VALUE="${PREVIEW_AWS_REGION:-us-east-1}"
          WEBSITE_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --region "${AWS_REGION_VALUE}" \
            --query "Stacks[0].Outputs[?OutputKey=='DeployBucketName'].OutputValue" \
            --output text)
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --region "${AWS_REGION_VALUE}" \
            --query "Stacks[0].Outputs[?OutputKey=='DeployDistributionId'].OutputValue" \
            --output text)
          {
            echo "WEBSITE_BUCKET=${WEBSITE_BUCKET}"
            echo "DISTRIBUTION_ID=${DISTRIBUTION_ID}"
          } >>"${GITHUB_OUTPUT}"

      - name: Run preview teardown
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          PR_NUMBER_VALUE="${PR_NUMBER}"
          PREVIEW_PREFIX_VALUE="${PREVIEW_PREFIX:-pr-}"
          AWS_REGION_VALUE="${PREVIEW_AWS_REGION:-us-east-1}"
          ./scripts/pr-preview/teardown.sh \
            --pr-number "${PR_NUMBER_VALUE}" \
            --bucket "${{ steps.describe.outputs.WEBSITE_BUCKET }}" \
            --distribution-id "${{ steps.describe.outputs.DISTRIBUTION_ID }}" \
            --preview-prefix "${PREVIEW_PREFIX_VALUE}" \
            --region "${AWS_REGION_VALUE}" \
            --supabase-db-url "${SUPABASE_PREVIEW_DB_URL}"

